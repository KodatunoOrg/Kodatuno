#ifndef _NURBS_FUNC_H_
#define _NURBS_FUNC_H_

#include "BODY.h"
#include "Describe_BODY.h"
#include "Quaternion.h"

#define PTNUMMAX			10000			// NURBSの点列の最大数
#define RANKMAX				9				// NURBSの階数の最大値
#define INTERSECPTNUMMAX	1000			// 交点格納配列長
#define NEAREST_GAP			0.01			// 2点が同一点とみなす距離
#define CONVERG_GAP			0.00001			// ニュートン法の収束を判別する閾値
#define CONVDIVNUM			10				// 収束計算用のパラメータ分割数
#define TRM_BORDERDIVNUM	100				// トリム境界線上に生成する点の数
#define FORWARD				1				// 交線追跡の方向(順)
#define INVERSE				-1				// 交線追跡の方向(逆)
#define OUTTER_TRIM			0				// 外周トリミング領域
#define INNER_TRIM			1				// 内周トリミング領域


// NURBSの操作を集めたクラスを定義
class NURBS_Func : public BODY_Handler
{
public:
	Coord CalcNurbsCCoord(NURBSC *,double);						// 指定したノットtでのNURBS曲線の座標値を求める
	void CalcNurbsCCoords(NURBSC *,int,double *,Coord *);		// 指定したノットt群でのNURBS曲線の座標値群を求める
	Coord CalcNurbsSCoord(NURBSS *,double,double);				// 指定したノットu,vでのNURBS曲面の座標点を求める
	void CalcNurbsSCoords(NURBSS *,int,Coord *,Coord *);		// 指定したノットu,v群でのNURBS曲面の座標値群を求める
	int GenNurbsC(NURBSC *,int,int,int,double [],double [],Coord [],double [],int[],int);	// 1つのNURBS曲線を生成する
	int GenNurbsC(NURBSC *,NURBSC);								// 1つのNURBS曲線を生成する(NURBS曲線のコピー)(オーバーロード)
	int GenNurbsS(NURBSS *,int,int,int,int,double *,double *,double **,Coord **,double,double,double,double);	// 1つのNURBS曲面を生成する
	int GenNurbsS(NURBSS *,NURBSS);								// 1つのNURBS曲面を生成する(NURBS曲面のコピー)(オーバーロード)
	int GenRotNurbsS(NURBSS *,NURBSC,Coord,double);				// 1つのNURBS曲線をある軸回りにある角度だけ回転させた回転サーフェスを生成する
	int GenSweepNurbsS(NURBSS *,NURBSC,Coord,double);			// 1つのNURBS曲線からある軸方向にある距離だけスイープさせたスイープサーフェスを生成する
	int GenTrimdNurbsS(TRIMD_NURBSS *,TRIMD_NURBSS);			// トリム面を生成する
	int DelTrimdNurbsS(TRIMD_NURBSS *);							// トリム面を削除(メモリー解放)する
	void DelNurbsC(NURBSC *);									// NURBS曲線を削除する
	void DelNurbsS(NURBSS *);									// NURBS曲面を削除する
	double CalcBSbasis(double,double [],int,int,int);			// Bスプライン基底関数を計算し、計算結果を返す
	double CalcDiffBSbasis(double,double [],int,int,int);		// Bスプライン基底関数の1階微分係数を求める
	double CalcDiffBSbasisN(double,double [],int,int,int,int);	// Bスプライン基底関数のN階微分係数を求める
	Coord CalcDiffNurbsC(NURBSC *,double);						// NURBS曲線の1階微分係数を求める
	Coord CalcDiff2NurbsC(NURBSC *NurbsC,double t);				// NURBS曲線の2階微分係数を求める
	Coord CalcDiffuNurbsS(NURBSS *,double,double);				// NURBS曲面のu方向1階微分係数を求める
	Coord CalcDiffvNurbsS(NURBSS *,double,double);				// NURBS曲面のv方向1階微分係数を求める
	Coord CalcDiffNurbsS(NURBSS *,int,int,double,double);		// NURBS曲面の各方向を任意階微分したときの微分係数を求める
	Coord CalcNormVecOnNurbsS(NURBSS *,double,double);			// NURBS曲面上の(u,v)における法線ベクトルをもとめる
	int CalcuIntersecPtNurbsLine(NURBSS *,Coord ,Coord ,Coord *,Coord *);	// NURBS曲面と直線の交点を算出
	int CalcIntersecCurve3(NURBSC *,Coord,Coord,double *,int);	// 3次以下のNURBS曲線と平面との交点を求める
	int CalcIntersecPtsPlaneV3(NURBSS *,Coord,Coord,int,Coord *,int);	// 3次以下のNURBS曲面と平面との交点群を代数計算で求める(vパラメータ分割)
	int CalcIntersecPtsPlaneU3(NURBSS *,Coord,Coord,int,Coord *,int);	// 3次以下のNURBS曲面と平面との交点群を代数計算で求める(uパラメータ分割)
	int CalcIntersecPtsPlaneSearch3(NURBSS *,Coord,Coord,double,int,Coord *,int);	// 3次以下のNURBS曲面と平面との交点群を交線追跡法で求める
	int CalcIntersecPtsNurbsSGeom(NURBSS *,NURBSS *,int,int,Coord *,Coord *,int);		// NURBS曲面同士の交線上の点を幾何学的にいくつか求める
	int CalcIntersecPtsNurbsSSearch(NURBSS *,NURBSS *,int,double,Coord *,Coord *,int);		// NURBS曲面同士の交線(交点群)を交線追跡法で求める
	int GetBSplCoef3(int,int,int,double *,double **);			// 3次のBスプライン曲線の各係数を求める　(at^3 + bt^2 + ct + dの係数a,b,c,dを返す)
	int GetBSplCoef2(int,int,int,double *,double **);			// 2次のBスプライン曲線の各係数を求める　(at^2 + bt + cの係数a,b,cを返す)
	int GetBSplCoef1(int,int,int,double *,double **);			// 1次のBスプライン曲線の各係数を求める　(at + bの係数a,bを返す)
	void ShiftNurbsS(NURBSS *,Coord);							// NURBS曲面のシフト
	void ShiftNurbsC(NURBSC *,Coord);							// NURBS曲線のシフト
	void ChRatioNurbsS(NURBSS *,Coord);							// NURBS曲面の倍率を変更する
	void ChRatioNurbsC(NURBSC *,Coord);							// NURBS曲線の倍率を変更する
	int SetCPNurbsS(NURBSS *,NURBSS);							// コントロールポイントを代入する
	int GenInterpolatedNurbsC1(NURBSC *,Coord *,int,int);		// 与えられた点列を補間するn階のNURBS曲線を生成する
	int GenInterpolatedNurbsC2(NURBSC *,Coord *,int,int);		// 与えられた点列を補間するn階のNURBS曲線を生成する(閉じた曲線)
	int GenApproximationNurbsC(NURBSC *,Coord *,int,int);		// 与えられた点列を近似するn階のNURBS曲線を生成する
	int GenPolygonalLine(NURBSC *,Coord *,int);					// 折れ線を生成する
	int GenInterpolatedNurbsS1(NURBSS *,Coord **,int,int,int,int);	// 与えられた点列を補間する4階のNURBS曲面を生成する
	int GenPolygonalSurface(NURBSS *,Coord **,int,int);				// 折れ面を生成する
	int DetermPtOnTRMSurf(TRMS *,double,double);					// 注目中のNURBS曲面上の1点(u,v)がトリミング領域内にあるのかを判定する
	void RotNurbsS(NURBSS *,Coord,double);							// NURBS曲面を回転
	void RotNurbsC(NURBSC *,Coord,double);							// NURBS曲線を回転
	int DetectInterfereNurbsS(NURBSS *,NURBSS *,int);				// NURBS曲面(トリム無)同士の干渉検出
	int DetectInterfereTrmS(TRIMD_NURBSS *,TRIMD_NURBSS *,int);		// NURBS曲面(トリム有)同士の干渉検出
	int CalcIntersecPtsPlaneGeom(NURBSS *,Coord,Coord,int,int,Coord *,int);			// NURBS曲面と平面との交点群を幾何学的に求める
	double CalcNurbsCLength(NURBSC *);							// NURBS曲線の線分長を求める
	double CalcNurbsCLength(NURBSC *,double,double);			// NURBS曲線の指定区間の線分長を求める
	int CalcDeltaPtsOnNurbsC(NURBSC *,double,Coord *);			// 指定した間隔でNURBS曲線上の座標値を出力する
	int CalcExtSearchCurve(NURBSS *,Coord,Coord,double,NURBSC *,NURBSC *);			// 極地探索線を得る
	int CalcExtGradCurve(NURBSS *,Coord,Coord,double,NURBSC *,NURBSC *);			// 極地傾斜線を得る


private:
	int GetNurbsCCoef(NURBSC *,double **,int,Coord *,double *);	// NURBS曲線の係数を求める(最高3次)
	int CalcEquation(double *,double *,int);					// 3次方程式までを判別して解く
	void GetNurbsSCoef(int,double **,double *,Coord *,int,Coord *,double *);	// NURBS曲面においてuまたはvを固定した場合に得られるNURBS曲線C(u) or C(v)の分母分子の係数を求める
	void GetIntersecEquation(int,Coord *,double *,Coord,Coord,double *);		// NURBS曲線と平面の交線導出用3次方程式を得る
	int SearchIntersectPt(NURBSS *,Coord,Coord,double,double *,double *,int);	// ニュートン法により交点を収束させる(NURBS曲面と平面)
	int SearchIntersectPt_RKM(NURBSS *,Coord,Coord,double,double *,double *,int);	// 4次のルンゲクッタ法により交点を収束させる(NURBS曲面と平面)
	int SearchIntersectPt(NURBSS *,NURBSS *,double,double *,double *,double *,double *,int);		// ニュートン法により交点を収束させる(NURBS曲面同士)
	int DetermPtOnTRMSurf_sub(CONPS *,double,double);						// トリム境界線が複合曲線の場合のトリミング領域内外判定
	void GetKnot(Vector,int,int,int,Vector);						// 曲線パラメータからノットベクトルを得る
	void GetKnotParam1(Coord *,int,Vector);							// 各通過点の曲線パラメータを算出(コード長の比から算出)
	void GetKnotParam2(Coord *,int,Vector);							// 各通過点の曲線パラメータを算出(コード長の平方根の比から算出)
	int CheckTheSamePoints(Coord *,int);							// 同一点を除去する
	double CalcDiffNurbsSDenom(NURBSS *,int,int,double,double);		// NURBS曲面分母の各方向を任意階微分したときの微分係数を求める
	Coord CalcDiffNurbsSNumer(NURBSS *,int,int,double,double);		// NURBS曲面分子の各方向を任意階微分したときの微分係数を求める

};

#endif
